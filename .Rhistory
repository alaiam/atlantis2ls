devtools::load_all(".")
devtools::load_all(".")
??read_atlantis
??atlantis2ls::read_atlantis
??osmose2R
library(osmose)
substrRight("htregbfdgdf/",1)
str_sub("htregbfdgdf/",-1)
library("stringr" )
str_sub("htregbfdgdf/",-1)
devtools::load_all(".")
fg <- fg %>% filter(IsTurnedOn==1)
extract_volume <- function(outputs.nc){
ncdf4::ncvar_get(outputs.nc, volume)
}
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
?paste0
print("Atlantis run is done!")
#' run_atlantis
#'
#' @return
#' @export
#'
#' @examples
run_atlantis <- function(path, sh.file) {
system(paste0("cd ",path ," sudo flip -uv *; sudo chmod +x ", sh.file,"; sudo sh ./", sh.file), wait = TRUE)
print("Atlantis run is done!")
}
run_atlantis
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
devtools::install_git(https://github.com/alaiam/atlantis2ls)
devtools::install_git("https://github.com/alaiam/atlantis2ls)
devtools::install_git("https://github.com/alaiam/atlantis2ls")
devtools::install_git("https://github.com/alaiam/atlantis2ls")
library(atlantis2ls)
??edit_param_mum_group_age
??atlantis2ls::edit_param_mum_group_age
devtools::document()
?run_atlantis
edit_param_mum_group_age
?edit_param_mum_group_age
devtools::load_all(".")
?edit_param_mum_group_age
devtools::load_all(".")
devtools::document()
?edit_param_mum_group_age
113+124+121+70+70
5951-498
5483-498
#demo
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
#Get mum_XXX bio.prm lines
bio.lines = readLines(bio.prm)
pattern = paste0('BHalpha_',species)
species = "HEP"
#Get mum_XXX bio.prm lines
bio.lines = readLines(bio.prm)
pattern = paste0('BHalpha_',species)
bio.lines.id = grep(pattern,bio.lines)
bio.lines.vals1 = bio.lines[bio.lines.id]
if (length(bio.lines.vals1)==0) stop("The species does not have a BHalpha parameter")
bio.lines.vals1
if (length(bio.lines.vals1)==0) stop("The species does not have a BHalpha parameter")
value <- as.numeric(unlist(strsplit(bio.lines.vals1, "\t"))[2])*factor
bio.lines.vals1
factor
factor = 2
value <- as.numeric(unlist(strsplit(bio.lines.vals1, "\t"))[2])*factor
name <- unlist(strsplit(bio.lines.vals1, "\t"))[1]
new.line <- paste0(name, "\t", value)
bio.lines[bio.lines.id] <- new.line
bio.lines
devtools::load_all(".")
devtools::document()
devtools::load_all(".")
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
?edit_param_sp
??edit_param_sp
edit_param_sp(bio.prm, param = "mUm", factor = 2, species = "HEP")
edit_param_sp(bio.prm, param = "bhbeta", factor = 2, species = "HEP")
devtools::load_all(".")
devtools::document()
#' edit_param_sp
#'
#' @param bio.prm
#' @param param
#' @param factor
#' @param species
#'
#' @return
#' @export
#'
#' @examples
edit_param_sp = function(bio.prm, param, factor, species){
if (tolower(param) == "mum"){
edit_param_mum_sp(bio.prm, factor, species)
}
if (tolower(param) == "bhbeta"){
edit_param_BHBeta_sp(bio.prm, factor, species)
}
if (tolower(param) == "bhaphla"){
edit_param_BHalpha_sp(bio.prm, factor, species)
}
}
edit_param_sp(bio.prm, param = "bhbeta", factor = 2, species = "HEP")
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
load_all()
edit_param_sp(bio.prm, param = "bhbeta", factor = 2, species = "HEP")
devtools::load_all(".")
edit_param_sp(bio.prm, param = "bhbeta", factor = 2, species = "HEP")
a <- edit_param_sp(bio.prm, param = "bhbeta", factor = 2, species = "HEP")
devtools::load_all(".")
devtools::load_all(".")
edit_param_sp(bio.prm, param = "bhbeta", factor = 2, species = "HEP")
#demo
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
outputs.nc <-open_main_nc(path, prefix = prefix)
devtools::load_all(".")
outputs.nc <-open_main_nc(path, prefix = prefix)
fg <- process_fg(fg.file)
vn <- c(paste0(fg$Name,"_Nums")) # variable name is functional group + "_N"
vn
ts <- ncdf4::ncvar_get(outputs.nc,varid = "t") %>% as.numeric
tyrs <- ts/(60*60*24*365) # from s to yrs
Ndat <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
Ndat
outputs.nc
View(outputs.nc)
vn
fg$Name
names(nc$var)
names(outputs.nc$var)
names(outputs.nc$var)
grep(outputs.nc$var, "_Nums")
names(outputs.nc$var)
bio.lines
grep("_Nums",outputs.nc$var)
names(outputs.nc$var)[grep("_Nums",outputs.nc$var)]
names(outputs.nc$var)[grep("_Nums",outputs.nc$var)]
vn <- names(outputs.nc$var)[grep("_Nums",outputs.nc$var)]
ts <- ncdf4::ncvar_get(outputs.nc,varid = "t") %>% as.numeric
tyrs <- ts/(60*60*24*365) # from s to yrs
Ndat <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
Ndat
names(Ndat)<- vn
names(Ndat)
fg$Name
#demo
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
devtools::load_all(".")
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
devtools::load_all(".")
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
devtools::load_all(".")
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
fg <- process_fg(fg.file)
fg
devtools::load_all(".")
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
View(a)
devtools::load_all(".")
devtools::load_all(".")
outputs.nc <-open_main_nc(path, prefix = prefix)
fg <- process_fg(fg.file)
vn <- names(outputs.nc$var)[grep("_Nums",outputs.nc$var)]
ts <- ncdf4::ncvar_get(outputs.nc,varid = "t") %>% as.numeric
tyrs <- ts/(60*60*24*365) # from s to yrs
Ndat <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
names(Ndat)<- vn
abund <- lapply(X = Ndat, FUN = calculate_abund, fg.file = fg, name = names(Ndat))
abund <- lapply(X = Ndat, FUN = calculate_abund)
abund
devtools::load_all(".")
devtools::load_all(".")
outputs.nc <-open_main_nc(path, prefix = prefix)
vn <- names(outputs.nc$var)[grep("_Nums",outputs.nc$var)]
Ndat <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
names(Ndat)<- vn
abund_allgrp <- lapply(X = Ndat, FUN = calculate_abund)
names(abund_allgrp) <- fg$Name
return(abund_allgrp)
abund_allgrp
names(abund_allgrp) <- fg$Name
abund_allgrp
names(abund_allgrp) <- names(Ndat)
abund_allgrp
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
species
data
data <- extract_abundance_grp(path, prefix = NULL)
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
data <- extract_abundance_grp(path, prefix = prefix)
test = grep(species,names(data))
species =fg$Name[43]
test = grep(species,names(data))
i.species = grep(species,names(data))
data[[i.species]]
data[i.species]
lapply(data[i.species], sum)
lapply(data[i.species], sum, 3)
Reduce('+', data[i.species])
devtools::load_all(".")
devtools::load_all(".")
fg <- process_fg(fg.file)
abund <- lapply(X = fg$Name, FUN = extract_abundance_sp(), path = path, prefix = prefix)
prefix
abund <- lapply(X = fg$Name, FUN = extract_abundance_sp, path = path, prefix = prefix)
abund
names(abund) <- fg$Name
abund
devtools::load_all(".")
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
devtools::load_all(".")
read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
View(a)
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
devtools::document()
warnings()
outputs.nc <-open_main_nc(path, prefix = prefix)
path = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data"
prefix = "AMPS"
fg.file = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/PugetSoundAtlantisFunctionalGroups_salmon_rectype4.csv"
bio.prm = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_2022.prm"
bio.prm2 = "C:/Users/Alaia/Desktop/Postdoc/R script/atlantis2ls/data/AMPSbioparam_mv1_20222.prm"
outputs.nc <-open_main_nc(path, prefix = prefix)
devtools::load_all(".")
devtools::load_all(".")
outputs.nc <-open_main_nc(path, prefix = prefix)
vn <- names(outputs.nc$var)[grep("_ResN",outputs.nc$var)]
Ndat <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
Ndat
names(Ndat)<- vn
vn
outputs.nc <-open_main_nc(path, prefix = prefix)
vn <- names(outputs.nc$var)[grep("_ResN",outputs.nc$var)]
data_Res <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
names(data_Res)<- vn
vn <- names(outputs.nc$var)[grep("_StructN",outputs.nc$var)]
data_Str <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
names(data_Str)<- vn
data_Str
names(data_Str)<- vn
data_Str
totnums <-nums %>% purrr::map(apply,MARGIN=3,FUN=sum) # total numbers by age group, time
vn <- names(outputs.nc$var)[grep("_Nums",outputs.nc$var)]
data_Nums <- purrr::map(1:length(vn), function(x) ncdf4::ncvar_get(outputs.nc,vn[x]))
names(data_Nums)<- vn
data_Nums
totnums <-data_Nums %>% purrr::map(apply,MARGIN=3,FUN=sum) # total numbers by age group, time
totnums
relnums <- purrr::map2(nums,totnums,sweep,MARGIN=3,FUN=`/`) # divide nums by totnums along the time axis to get relative annual nums per age group/box/layer
relnums <- purrr::map2(data_Nums,totnums,sweep,MARGIN=3,FUN=`/`) # divide nums by totnums along the time axis to get relative annual nums per age group/box/layer
relnums
wgt =(resN*relnums+strucN*relnums)*20*5.7/1e6
wgt =(data_Res*relnums+data_Str*relnums)*20*5.7/1e6
data_Res
relnums
(data_Res*relnums+data_Str*relnums)
relnums
View(relnums)
wgt =(purrr::map2(data_Res,relnums,`*`)+purrr::map2(data_Str,relnums,`*`))*20*5.7/1e6
purrr::map2(data_Res,relnums,`*`)
(purrr::map2(data_Res,relnums,`*`)+purrr::map2(data_Str,relnums,`*`))%>%
purrr::map(apply,MARGIN=3,FUN=sum)
(purrr::map2(data_Res,relnums,`*`)+purrr::map2(data_Str,relnums,`*`))
purrr::map2(data_Res,relnums,`*`)
data_Str
purrr::map2(data_Str,relnums,`*`)
wgt = (purrr::map2(data_Res,relnums,`*`)*20*5.7/1e6 + purrr::map2(data_Str,relnums,`*`))*20*5.7/1e6 %>%
purrr::map(apply,MARGIN=3,FUN=sum)
(purrr::map2(data_Res,relnums,20*5.7/1e6,`*`)
)
purrr::map2(data_Res,relnums,`*`)
purrr::map2(purrr::map2(data_Res,relnums,`*`), purrr::map2(data_Res,relnums,`*`), `+`)
wgt = lapply(purrr::map2(purrr::map2(data_Res,relnums,`*`), purrr::map2(data_Res,relnums,`*`), `+`),"*",20*5.7/1e6)
wgt
wgt = lapply(purrr::map2(purrr::map2(data_Res,relnums,`*`), purrr::map2(data_Res,relnums,`*`), `+`),"*",20*5.7/1e6)%>%
purrr::map(apply,MARGIN=3,FUN=sum)
wgt
wgt = lapply(purrr::map2(purrr::map2(data_Str,relnums,`*`), purrr::map2(data_Res,relnums,`*`), `+`),"*",20*5.7/1e6)%>%
purrr::map(apply,MARGIN=3,FUN=sum)
wgt
devtools::load_all(".")
a <- extract_waa(path = path, prefix = prefix)
a
devtools::load_all(".")
read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
data <- extract_abundance_grp(path, prefix = prefix)
i.species = grep(species,names(data))
species = "CHY"
i.species = grep(species,names(data))
i.species
if (length(i.species)){
return(Reduce('+', data[i.species]))
}else{
return(NA)
}
length(i.species)
devtools::load_all(".")
read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
a <- extract_waa(path=path, prefix = prefix)
# a lot of lines to actually read the data
output = list(biomass= extract_biomass_main(path = path, prefix = prefix, fg.file = fg.file),
landings=extract_catch_main(path, prefix = prefix, fg.file, fishery = F),
abundance= extract_abund_main(path, prefix = prefix, fg.file),
waa = extract_waa)
devtools::load_all(".")
read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
devtools::load_all(".")
a <- read_atlantis(path = path, prefix = prefix, fg.file = fg.file)
